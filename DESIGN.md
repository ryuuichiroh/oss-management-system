# OSS 管理システム

## 背景

- 弊社では、様々な OSS をソフトウェア製品開発に利用している
- 利用している OSS は、「OSS 利用管理シート」というエクセルファイルで管理されている
- OSS 利用管理シートは、以下のタイミングで担当者の「見直し」と管理者の「承認」を行う:
    - OSS の新規導入／更新時
    - リリース物件作成時
- OSS の新規導入／更新時には、以下の項目をチェックする:
    - OSS の情報
        - OSS 名
        - バージョン
        - ライセンス種別
    - 改変有無
    - 利用方法: 静的/動的リンク
    - 製品構成:
        - OSS をユーザーに配布するか
            - デバイス、または、ソフトウェアパッケージに同梱して配布する形態
            - OSS はサーバーにインストールされ、OSS がユーザーのブラウザに配布される携帯
        - OSS はサーバーにインストールされるが、OSS はユーザーには配布されないか
            - ユーザーはネットワークを介して自社のクラウドサービスを利用する形態
- リリース物件作成時には、以下の項目をチェックする:
    - 利用している OSS のライセンス情報の提供 (提供場所の提示) 
    - ソースコードの提供 (対応不要 / 実施済み)
        - ソースコードを提供する場合は、その場所
    - NOTICE ファイルの提供 (Apache 2.0 ライセンスの場合)

## 現在の課題
- OSS の数が多く、更新頻度が高いため、以下の課題がある
    - OSS 管理シートの更新漏れ、ミス
    - OSS 管理シートが未承認のままの製品リリース

## 課題の解決策

- 担当者が OSS の利用管理シートを更新作業を廃止し、ツールによって SBOM を自動生成することでミスを防ぐ
- 更新前の SBOM との差分を自動チェックさせ、差分項目のみ「見直し」と「承認」を要求することでミスを減らす
- 「見直し」と「承認」の状態を可視化し、未承認のままリリースされることを防ぐ

## 想定ユースケース

### 1. OSS の新規導入／更新時に、SBOM を自動生成する

- ソースコードは GitHub で管理されている
- PR 作成時に、ブランチから SBOM を自動作成する
- 前回リリースしたバージョンの SBOM との差分を自動比較する
    - OSS を意図せずに更新していないか担当者が気づけるようにするため
- 差分のあったライセンスごとに実施すべきガイドを担当者に提示する
    - 例:
        - OSS を改変している場合、～してください
        - GPL ライセンスです。OSS を静的リンクしている場合、～してください
        - Apache 2.0 ライセンスです。NOTICE ファイルを～してください
        - OSS がユーザーに配布される場合、～してください
        - デュアルライセンスです。
            - (A) を選ぶ場合は、ソースコードの開示が必要です
            - (B) を選ぶ場合は、～ライセンスとは互換性がありません

### 2. リリース物件作成時にリリースバージョンに対応する SBOM を作成し、担当者に「見直し」タスクをアサインする

- タグの作成をトリガーに、メインブランチから SBOM を作成する
- 前回リリースしたバージョンの SBOM との差分を自動比較し、指定された担当者に「見直し」タスクをアサインする
    
### 3. 担当者が「見直し」をして、承認者に「承認」を依頼する

- アサインされている「見直し」タスクのページを開き、差分を確認する
- 必要な対応を確認し、差分のあった OSS ごとに対応し、その対応結果を入力する
    - 「対応不要」や「実施済み」などの固定のチェック項目以外に、ライセンス情報の確認場所 (URL) などの入力が必要
- 管理者に「承認」タスクがアサインされる

### 4. 管理者が「承認」をして、SBOM を中央管理システムに正式登録する

- アサインされている「承認」タスクのページを開き、差分を確認する
- 問題があれば、担当者に「差し戻し」を通知する
- 問題がなければ、「承認」し、SBOM は中央管理システムに自動登録される

## システムへの要求

- 完璧なシステムを作らないが、拡張が難しいシステム構成や技術を採用してはならない
- システムの開発・運用にはあまりお金を使えない

## テクノロジースタック

- Dependency-Track (DT): 
    - CycloneDX 形式の SBOM の中央管理システム
    - Web API で SBOM の情報を取得/更新可能
- GitHub (GH)
    - GitHub Issue Forms
        - フォーマットを強制するために利用
    - GitHub Actions (GHA):
        - Syft を使った SBOM の生成
        - 指定されたリリース物件に対応する SBOM との差分比較
        - 「見直し」、「承認」タスクの PR または Issue の作成
- Syft:
    - SBOM の作成

### 必要に応じて採用するテクノロジー

- GitHub Pages:
    - SPDX 形式の SBOM の保存が必要な場合など
- TypeScript/JavaScript:
    - bash だと煩雑になりがちな複雑なロジックが必要な場合など
- HTML/CSS:
    - 監査レポートを生成する時 (必要があれば)

## システム設計のポイント

- 「差分」へのフォーカス: 変更点だけを追いかけるのは、開発スピードを落とさないための現実的な解である
- ライセンスガイドの提示: 「何をすればいいか」をその場で提示することで、法務知識が乏しい担当者でも迷わず対応できる
- GitHub の利用: 
    - 低予算で開始できる。なお、GHA の費用はリポジトリごとに月額で管理される
    - 作成された PR や Issue が変更は履歴が残るため、監査に強い
        - 他の人による更新に気づける
        - 承認後の更新に気づける
    - GHA により開発チームごとにフローやロジックのカスタマイズがしやすい
- DT の利用: 各ソフトウェアが利用している OSS についての対応結果も、製品バージョンごとに中央管理できる

## システムの処理フロー

### 1. OSS の新規導入／更新時に、SBOM を自動生成する

PR を作成すると、GHA により以下の処理が開始される:

1. PR に対応するブランチの SBOM 作成
1. DT から比較対象の SBOM 取得
1. SBOM の差分比較
1. ライセンスごとのガイド情報の取得
1. ライセンスごとに必要な対応を、トリガーとなった PR のコメント投稿

#### 補足

- PR には以下が提示される: 
    - 差分のあったライセンス
    - 差分のあったライセンスごとに実施すべきガイド

- ライセンスごとのガイド情報:
    - GHA から参照可能な場所に、ファイルで用意しておく
    - ファイルフォーマット: "ライセンスごとのガイド情報" を参照

- PR へのコメント
    - 固定フォーマットで出力する

- 生成された SBOM は、GitHub Artifact からダウンロードできる

### 2. リリース物件作成時にリリースバージョンに対応する SBOM を作成し、担当者に「見直し」タスクをアサインする

タグを作成すると、GHA により以下の処理が開始される:

1. メインブランチを対象に SBOM 作成
1. DT から比較対象の SBOM 取得
1. SBOM の差分比較
1. ライセンスごとのガイド情報の取得
1. 「見直し」項目の作成
1. 新たに GH Issue を作成し、設定されている担当者に「見直し」タスクを割り当てる

#### 補足

- 作成される GH Issue は、"GitHub Issue の例" を参考にすること
    - サンプルであるため、過不足や不整合があるならばサンプルと乖離してよい
- GH Issue には、「承認依頼」をするか否かのチェックボックスを用意する
- 生成された SBOM は、当該 GHA の Artifact からダウンロードできるようにする
    - そのリンクは Issue にも表示する

### 3. 担当者が「見直し」をして、承認者に「承認」を依頼する

「見直し」タスクの Issue をクローズすると GHA で以下の処理が開始される:

1. 「承認依頼」のチェック状態を確認する
1. ON の場合:
    1. GHA のトリガーとなった Issue から、担当者による対応結果と SBOM のリンクを取得する
    1. 対応結果を用いて新たな Issue を作成し、指定された管理者に「承認」タスクを割り当てる

#### 補足

- 「承認依頼」が OFF の場合、GHA はそのまま終了する
- 対応結果は、JSON 形式で、当該 GHA の Artifact からダウンロードできるようにする
- 関連する SBOM と対応結果と JSON ファイルのリンクも、承認タスクの Issue に表示される

### 4. 管理者が「承認」をして、SBOM を中央管理システムに正式登録する

「承認」タスクの Issue をクローズすると GHA で以下の処理が開始される:

1. 「承認」のチェック状態を確認する
1. ON の場合:
    1. トリガとなった Issue に設定されている SBOM の用いて、DT にプロジェクトを登録する
    1. トリガとなった Issue に設定されている対応結果を用いて、登録した DT のプロジェクトにプロパティを追加する

#### 補足

- 「承認」が OFF の場合、GHA はそのまま終了する
- DT はプロジェクトのバージョンごとに SBOM を管理する
- **{2/9追加}** DT に登録するときのバージョンは Git のタグと同じである
- DT では、利用している OSS は、コンポーネントごとに管理されている
- OSS ライセンスごとの対応は、対応するコンポーネントのプロパティとして登録する
- DT に登録されているコンポーネントの ID は、sbom の components に含まれる情報 (group, name, vesion) を利用して絞り込む

### システムの処理フローに共通する補足

- SBOM の差分は、components の以下の情報の不一致で判断する
    - group
    - name
    - version
- Issue は、担当者や管理者へのガイドや入力を強制するため GitHub Issue Form (YAML) を利用する
- Syft の利用方法: SYFT+GRYPE.md
- DT の Web API の利用方法: README.md

- **{2/9追加}** DT にから比較対象の SBOM が得られなければ、最初のバージョンである
    - 最初のバージョンでは、全ての OSS は新規追加として扱う

- **{2/9追加}** DT で管理するプロジェクトのバージョンは、GHA の呼び出し元のリポジトリのルートに存在する `oss-management-system.yml` で指定される
    - 定義例:
        ```
        # ファイル名: oss-management-system.yml

        # 差分比較時に DT から取得するプロジェクトバージョン
        pre-project-version: v1.0.0       
        ```
    - 以下の場合は、最初のバージョンである
        - oss-management-system.yml が存在しない
        - oss-management-system.yml に `pre-project-version` キーが存在しない
        - oss-management-system.yml に `pre-project-version` の値が存在しない

- **{2/9追加}** GHA は他のリポジトリから呼び出されて利用される

### あとで対応する項目

- 「見直し」や「承認」のタスクのアサイン先の指定方法
    - GitHub Environments 機能の "Required reviewers" を利用する
        - 管理者の承認がない限り DT への登録をさせないために利用する
        - 利用方法:
            ```
            - name: Assign Reviewer
            uses: actions/github-script@v7
            with:
                script: |
                github.rest.issues.addAssignees({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: context.issue.number,
                    assignees: ['my-oss-review-team'] # ここにチーム名を指定
                })
            ```
    - 今回は、手動でアサインを設定・連絡する

## ライセンスごとのガイド情報

### license-guidelines.yml の例

```
version: "1.0"
guidelines:
  - license_id: "Apache-2.0"
    common_instructions: "Apache License 2.0 の規定に従い、著作権表示と許諾表示を保持してください。"
    rules:
      - condition: "always"
        message: "リポジトリ内に NOTICE ファイルが含まれているか確認し、含まれている場合は製品に同梱してください。"
        input_type: "checkbox"
        label: "NOTICEファイルの対応"
      - condition: "is_modified == true"
        message: "改変を加えたファイルに、変更した旨の告知を記載してください。"
        input_type: "text"
        label: "改変内容のサマリ"

  - license_id: "GPL-3.0-only"
    common_instructions: "強いコピーレフトライセンスです。ソースコードの開示義務に注意してください。"
    rules:
      - condition: "link_type == 'static'"
        message: "静的リンクでの利用です。製品全体のソースコード開示が必要になります。構成を見直すか、法務担当に相談してください。"
        input_type: "select"
        options: ["構成を見直した", "法務承認済み", "ソースコードを開示する"]
        label: "GPL静的リンクの対応"
      - condition: "is_distributed == true"
        message: "ユーザーへの配布が伴うため、ソースコードの提供方法（場所）を提示してください。"
        input_type: "text"
        label: "ソースコード提供場所(URL等)"

  - license_id: "Dual-License-Example" # デュアルライセンスの例
    common_instructions: "このOSSはデュアルライセンスです。適用するライセンスを選択してください。"
    rules:
      - condition: "always"
        message: "どちらのライセンスを適用しますか？"
        input_type: "select"
        options: ["Commercial License", "GPL-2.0"]
        label: "適用ライセンスの選択"
```

## GitHub Issue の例

### 「見直し」タスクの場合

```
# 📦 OSS利用見直しタスク (v1.1.0 -> v1.2.0)

GitHub Actions により、前回リリース時（v1.1.0）との SBOM 差分が検知されました。
担当者は以下のテーブルを確認し、必要な対応を行った上でチェックを入れてください。

## 🔍 差分一覧とガイドライン
各 OSS の「ライセンス種別」と「改変有無」に基づき、対応が必要です。

| 🚨 | OSS名 | バージョン | ライセンス | 変更 | 改変 | 配布 | 対応状況 / 証跡リンク |
| :---: | :--- | :--- | :--- | :--- | :--- | :--- | :--- |
| ⚠️ | **lib-scanner** | `2.1.0` | Apache-2.0 | 新規 | あり | 同梱 | [ ] 未対応 (NOTICE要) |
| ✅ | **fast-json** | `1.5.0` | MIT | 更新 | なし | SaaS | [x] 実施済み |
| 🚫 | **gpl-tool** | `3.0.0` | GPL-3.0 | 新規 | なし | 同梱 | [ ] 未対応 (ソース開示確認要) |

---

## 📝 担当者入力エリア
「見直し」ステータスを更新するため、以下の項目を入力してください。

### 1. 共通チェック事項
- [ ] すべての新規 OSS について、ライセンス種別に誤りがないことを確認した。
- [ ] 意図しないバージョンアップが含まれていないことを確認した。

### 2. 個別対応詳細 (必要な場合のみ)
> **lib-scanner (Apache-2.0)**
> - [ ] NOTICE ファイルを製品パッケージに同梱しました。
> - **ライセンス情報の提示場所 (URL):** >   `ここにURLを記入`

---

## 🚀 次のステップ
1. 担当者がすべての確認を終えたら、この Issue を **Close** してください。
2. Close をトリガーに、管理者へ「承認依頼」の Issue が自動作成されます。
3. 管理者の承認後、SBOM は中央管理システム (Dependency-Track) へ正式登録されます。

**担当者:** @username
**承認者候補:** @manager_name
```
