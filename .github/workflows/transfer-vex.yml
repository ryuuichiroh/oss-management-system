name: Transfer VEX decisions (manual)

on:
  workflow_dispatch:
    inputs:
      projectName:
        description: "プロジェクト名"
        required: true
        default: "log4j-vulnerable-sample"
      fromVersion:
        description: "引き継ぎ元バージョン（例: 1.0.0）"
        required: true
      toVersion:
        description: "引き継ぎ先バージョン（例: 2.0.0）"
        required: true

permissions:
  contents: none

jobs:
  transfer-vex:
    runs-on: ubuntu-latest
    env:
      DT_BASE_URL: ${{ secrets.DT_BASE_URL }}
      DT_API_KEY:  ${{ secrets.DT_API_KEY }}

    steps:
      - name: Install jq & curl
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Lookup source/target UUID
        id: lookup
        run: |
          PN="${{ inputs.projectName }}"
          FV="${{ inputs.fromVersion }}"
          TV="${{ inputs.toVersion }}"

          SRC=$(
            curl -sS \
              "$DT_BASE_URL/v1/project/lookup?name=$(printf %s "$PN" | jq -sRr @uri)&version=$(printf %s "$FV" | jq -sRr @uri)" \
              -H "X-Api-Key: $DT_API_KEY" \
            | jq -r '.uuid // empty'
          )
          
          TGT=$(
            curl -sS \
              "$DT_BASE_URL/v1/project/lookup?name=$(printf %s "$PN" | jq -sRr @uri)&version=$(printf %s "$TV" | jq -sRr @uri)" \
              -H "X-Api-Key: $DT_API_KEY" \
            | jq -r '.uuid // empty'
          )

          if [ -z "$SRC" ]; then echo "❌ Source not found: $PN:$FV" >&2; exit 1; fi
          if [ -z "$TGT" ]; then echo "❌ Target not found: $PN:$TV" >&2; exit 1; fi

          echo "src=$SRC" >> "$GITHUB_OUTPUT"
          echo "tgt=$TGT" >> "$GITHUB_OUTPUT"
          echo "Found: SRC=$SRC, TGT=$TGT"

      - name: Export VEX (CycloneDX) from source
        run: |
          mkdir -p artifacts
          curl -sS "$DT_BASE_URL/v1/vex/cyclonedx/project/${{ steps.lookup.outputs.src }}" \
            -H "X-Api-Key: $DT_API_KEY" \
            -o artifacts/vex-from.json
          # 参考：このエクスポート API は CycloneDX VEX を返す（JSON／XML）[1](https://rfgricoh-my.sharepoint.com/personal/ryuuichiroh_nakayama_jp_ricoh_com/Documents/Microsoft%20Copilot%20%E3%83%81%E3%83%A3%E3%83%83%E3%83%88%20%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB/sbom-log4j-1.1.3.json)
          test -s artifacts/vex-from.json || { echo "❌ Empty VEX" >&2; exit 1; }

      - name: (Optional) Quick sanity check of VEX
        run: |
          echo "Top-level fields:"; jq 'keys' artifacts/vex-from.json | head -n 20 || true
          # ここで必要なら VEX の調整（component マッピング等）を実装

      - name: Import VEX to target
        run: |
          PN="${{ inputs.projectName }}"
          TV="${{ inputs.toVersion }}"
          curl -sS -X POST "$DT_BASE_URL/v1/vex" \
            -H "X-Api-Key: $DT_API_KEY" \
            -F "projectName=$PN" \
            -F "projectVersion=$TV" \
            -F "vex=@artifacts/vex-from.json"
          # /v1/vex は multipart(POST) と Base64 JSON(PUT) をサポート。POST はサイズ上限に実質縛られず安全。[1](https://rfgricoh-my.sharepoint.com/personal/ryuuichiroh_nakayama_jp_ricoh_com/Documents/Microsoft%20Copilot%20%E3%83%81%E3%83%A3%E3%83%83%E3%83%88%20%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB/sbom-log4j-1.1.3.json)

      - name: Done
        run: echo "✅ Transferred VEX from ${{ inputs.fromVersion }} to ${{ inputs.toVersion }}"
