name: Main → Dependency-Track Sync

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  dt-sync:
    runs-on: ubuntu-latest
    env:
      DT_BASE_URL: ${{ secrets.DT_BASE_URL }}
      DT_API_KEY:  ${{ secrets.DT_API_KEY }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install jq
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      # 1) SBOM 生成（Trivy でも Syft でもOK。ここは Trivy 例）
      - name: Generate SBOM (CycloneDX JSON)
        run: |
          mkdir -p artifacts
          docker run --rm -v "$PWD":/work aquasec/trivy:latest fs \
            --format cyclonedx \
            --output /work/artifacts/sbom.json \
            /work

      # 2) SBOM から projectName / projectVersion を抽出（2ホップ法）
      - name: Derive projectName / projectVersion from SBOM
        id: meta
        run: |
          set -e
          ROOT_REF=$(jq -r '.metadata.component["bom-ref"]' artifacts/sbom.json)
          POM_REF=$(jq -r --arg rr "$ROOT_REF" '
            .dependencies[] | select(.ref==$rr) | .dependsOn[]' artifacts/sbom.json)
          SELF_REF=$(jq -r --arg pr "$POM_REF" '
            .dependencies[] | select(.ref==$pr) | .dependsOn[]' artifacts/sbom.json)

          PN=$(jq -r --arg sr "$SELF_REF" '.components[] | select(."bom-ref"==$sr) | .name' artifacts/sbom.json)
          PV=$(jq -r --arg sr "$SELF_REF" '.components[] | select(."bom-ref"==$sr) | .version' artifacts/sbom.json)

          if [ -z "$PN" ] || [ -z "$PV" ] || [ "$PN" = "null" ] || [ "$PV" = "null" ]; then
            echo "SBOM から name/version を特定できませんでした" >&2
            exit 1
          fi
          echo "projectName=$PN"   >> $GITHUB_OUTPUT
          echo "projectVersion=$PV" >> $GITHUB_OUTPUT
          echo "Detected PN=$PN PV=$PV"

      # 3) /v1/bom にアップロード（autoCreate=true で未存在は自動作成）
      - name: Upload SBOM to Dependency-Track
        run: |
          curl -sS -X POST "$DT_BASE_URL/v1/bom" \
            -H "X-Api-Key: $DT_API_KEY" \
            -F "autoCreate=true" \
            -F "projectName=${{ steps.meta.outputs.projectName }}" \
            -F "projectVersion=${{ steps.meta.outputs.projectVersion }}" \
            -F "bom=@artifacts/sbom.json"

      # 4) アクティブ版サマリを作成し、VEX引き継ぎ候補を提案
      - name: Summarize active versions and propose VEX transfer (SemVer-aware)
        env:
          PN: ${{ steps.meta.outputs.projectName }}
          CUR: ${{ steps.meta.outputs.projectVersion }}
          REPO: ${{ github.repository }}
          DT_BASE_URL: ${{ secrets.DT_BASE_URL }}
          DT_API_KEY:  ${{ secrets.DT_API_KEY }}
        run: |
          set -euo pipefail

          # DT から同名の active バージョン一覧を取得
          RESP=$(curl -sS \
            "$DT_BASE_URL/v1/project?name=$(printf %s "$PN" | jq -sRr @uri)&excludeInactive=true" \
            -H "X-Api-Key: $DT_API_KEY")

          # JSON でなければ早期終了（トラブル検知）
          echo "$RESP" | jq -e . >/dev/null || {
            echo "Dependency-Track response is not JSON. Please check DT_BASE_URL / API key."
            exit 1
          }

          # 例: ["2.0.0","1.1.0","1.0.0"]
          ACTIVE_VERS=$(echo "$RESP" | jq -r '.[].version' | sed '/^$/d')

          # SemVerとして自分より“古い”activeのみ抽出
          # sort -V は 1.2.10 > 1.2.9 など数値として比較してくれる
          # 自分より小さいものだけを列挙
          readarray -t CANDIDATES < <(
            { echo "$ACTIVE_VERS" | grep -vx -- "$CUR" || true; } \
            | xargs -I{} bash -c 'printf "%s\n" "{}|$(printf "%s\n" "{}" "$CUR" | sort -V | head -n1)"' \
            | awk -F'|' '$1==$2 {print $1}' \
            | sort -V
          )

          # “直前の active 旧版”を1件推薦（任意）
          PREV_CAND=""
          if [ ${#CANDIDATES[@]} -gt 0 ]; then
            PREV_CAND="${CANDIDATES[-1]}"  # 一番新しい旧版
          fi

          {
            echo "## 🔁 VEX の引き継ぎ候補 (Dependency-Track / SemVer)"
            echo
            echo "**Project**: \`$PN\`"
            echo
            echo "**Current version (just registered)**: \`$CUR\`"
            echo
            echo "**Active versions in DT:**"
            if [ -n "$ACTIVE_VERS" ]; then
              echo "$ACTIVE_VERS" | sed 's/^/- /'
            else
              echo "- (none)"
            fi
            echo

            if [ ${#CANDIDATES[@]} -gt 0 ]; then
              echo "### ⚠️ Transfer VEX suggestions (older-than-current, SemVer)"
              for v in "${CANDIDATES[@]}"; do
                if [ -n "$v" ]; then echo "- **$v**"; fi
              done
              echo
              if [ -n "$PREV_CAND" ]; then
                echo "**おすすめ:** 直前の旧版 \`$PREV_CAND\` → \`$CUR\` へ VEX を移送"
                echo
                echo "**起動手順:**"
                echo "1. Actions → **Transfer VEX decisions (manual)** を開く"
                echo "2. 入力："
                echo "   - \`projectName\` = \`$PN\`"
                echo "   - \`fromVersion\` = \`$PREV_CAND\`"
                echo "   - \`toVersion\`   = \`$CUR\`"
                echo
                echo "➡️ ワークフローを開く: https://github.com/$REPO/actions/workflows/transfer-vex.yml"
                echo
                echo "> 参考API: Export \`GET /v1/vex/cyclonedx/project/{uuid}\`, Import \`POST /v1/vex\`（multipart 推奨）"
              fi
            else
              echo "✅ 自分より古い active 版はありません。引き継ぎ候補は無し。"
            fi
          } >> "$GITHUB_STEP_SUMMARY"
