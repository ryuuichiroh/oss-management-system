name: Reusable Approval Issue Close

on:
  workflow_call:
    inputs:
      node-version:
        description: 'Node.js version to use'
        required: false
        type: string
        default: '20'
    secrets:
      DT_BASE_URL:
        description: 'Dependency-Track base URL'
        required: false
      DT_API_KEY:
        description: 'Dependency-Track API key'
        required: false

jobs:
  process-approval:
    runs-on: ubuntu-latest
    # Only run if the issue has the 'oss-approval' label
    if: contains(github.event.issue.labels.*.name, 'oss-approval')
    
    steps:
      - name: Checkout calling repository
        uses: actions/checkout@v4
      
      - name: Checkout OSS management scripts
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository_owner }}/oss-management-system
          path: .oss-management
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node-version }}
      
      - name: Install OSS management dependencies
        run: |
          cd .oss-management
          npm ci
          npm run lint
          npm run build
      
      - name: Save issue body to file
        run: |
          cat > issue-body.txt << 'EOF'
          ${{ github.event.issue.body }}
          EOF
      
      - name: Extract version from issue title
        id: extract-version
        run: |
          TITLE="${{ github.event.issue.title }}"
          # Extract version from title like "[Approval] OSSÂà©Áî®ÊâøË™ç v1.0.0"
          VERSION=$(echo "$TITLE" | sed -n 's/.*OSSÂà©Áî®ÊâøË™ç \(.*\)/\1/p' | xargs)
          if [ -z "$VERSION" ]; then
            VERSION="unknown"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Extracted version: $VERSION"
      
      - name: Check approval status
        id: check-approval
        run: |
          node .oss-management/dist/scripts/issue-parser.js approval issue-body.txt
          APPROVED=$?
          if [ $APPROVED -eq 0 ]; then
            echo "approved=true" >> $GITHUB_OUTPUT
            echo "Approval status: APPROVED"
          else
            echo "approved=false" >> $GITHUB_OUTPUT
            echo "Approval status: NOT APPROVED"
          fi
      
      - name: Extract artifact run IDs from issue body
        if: steps.check-approval.outputs.approved == 'true'
        id: extract-run-ids
        run: |
          # Extract SBOM artifact run ID
          SBOM_RUN_ID=$(cat issue-body.txt | grep -oP 'SBOM.*?actions/runs/\K[0-9]+' | head -1)
          if [ -z "$SBOM_RUN_ID" ]; then
            echo "Error: Could not extract SBOM run ID from issue body"
            exit 1
          fi
          echo "sbom_run_id=$SBOM_RUN_ID" >> $GITHUB_OUTPUT
          echo "SBOM run ID: $SBOM_RUN_ID"
          
          # Extract review results run ID
          REVIEW_RUN_ID=$(cat issue-body.txt | grep -oP 'Ë¶ãÁõ¥„ÅóÁµêÊûú.*?actions/runs/\K[0-9]+' | head -1)
          if [ -z "$REVIEW_RUN_ID" ]; then
            echo "Error: Could not extract review results run ID from issue body"
            exit 1
          fi
          echo "review_run_id=$REVIEW_RUN_ID" >> $GITHUB_OUTPUT
          echo "Review results run ID: $REVIEW_RUN_ID"
      
      - name: Download SBOM artifact
        if: steps.check-approval.outputs.approved == 'true'
        uses: actions/download-artifact@v4
        with:
          name: sbom-tag-${{ steps.extract-version.outputs.version }}
          run-id: ${{ steps.extract-run-ids.outputs.sbom_run_id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          path: ./artifacts/sbom
      
      - name: Download review results artifact
        if: steps.check-approval.outputs.approved == 'true'
        uses: actions/download-artifact@v4
        with:
          name: review-results-${{ steps.extract-version.outputs.version }}
          run-id: ${{ steps.extract-run-ids.outputs.review_run_id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          path: ./artifacts/review
      
      - name: Verify downloaded artifacts
        if: steps.check-approval.outputs.approved == 'true'
        id: verify-artifacts
        run: |
          # Find SBOM file (must have bomFormat field)
          SBOM_FILE=""
          for file in ./artifacts/sbom/*.json; do
            if [ -f "$file" ] && jq -e '.bomFormat' "$file" > /dev/null 2>&1; then
              SBOM_FILE="$file"
              break
            fi
          done
          
          if [ -z "$SBOM_FILE" ]; then
            echo "Error: SBOM file not found in downloaded artifact"
            echo "Available files:"
            ls -la ./artifacts/sbom/
            exit 1
          fi
          echo "sbom_path=$SBOM_FILE" >> $GITHUB_OUTPUT
          echo "Found SBOM: $SBOM_FILE"
          
          # Find review results file
          REVIEW_FILE=$(find ./artifacts/review -name "*.json" -type f | head -1)
          if [ -z "$REVIEW_FILE" ]; then
            echo "Error: Review results file not found in downloaded artifact"
            exit 1
          fi
          echo "review_path=$REVIEW_FILE" >> $GITHUB_OUTPUT
          echo "Found review results: $REVIEW_FILE"
          
          # Display file info
          echo "SBOM components count: $(jq '.components | length' "$SBOM_FILE")"
          echo "Review results count: $(jq '.results | length' "$REVIEW_FILE")"
      
      - name: Upload SBOM to Dependency-Track
        if: steps.check-approval.outputs.approved == 'true'
        id: upload-sbom
        run: |
          PROJECT_NAME="${{ github.repository }}"
          VERSION="${{ steps.extract-version.outputs.version }}"
          
          echo "Uploading SBOM to Dependency-Track..."
          echo "Project: $PROJECT_NAME"
          echo "Version: $VERSION"
          
          node .oss-management/dist/scripts/dt-client-cli.js upload-sbom "$PROJECT_NAME" "$VERSION" "${{ steps.verify-artifacts.outputs.sbom_path }}"
          
          echo "SBOM uploaded successfully"
        env:
          DT_BASE_URL: ${{ secrets.DT_BASE_URL }}
          DT_API_KEY: ${{ secrets.DT_API_KEY }}
      
      - name: Set component properties from review results
        if: steps.check-approval.outputs.approved == 'true'
        run: |
          PROJECT_NAME="${{ github.repository }}"
          VERSION="${{ steps.extract-version.outputs.version }}"
          REVIEW_RESULTS_PATH="${{ steps.verify-artifacts.outputs.review_path }}"
          
          echo "Setting component properties from review results..."
          
          # Parse JSON and iterate over results
          node -e "
            const fs = require('fs');
            const reviewResults = JSON.parse(fs.readFileSync('$REVIEW_RESULTS_PATH', 'utf-8'));
            
            for (const result of reviewResults.results) {
              const component = {
                group: result.component.group,
                name: result.component.name,
                version: result.component.version
              };
              
              // Set each action as a property
              for (const [label, value] of Object.entries(result.actions)) {
                const componentJson = JSON.stringify(component);
                const propertyName = 'review_' + label.replace(/[^a-zA-Z0-9]/g, '_').toLowerCase();
                const propertyValue = value;
                
                console.log(\`Setting property \${propertyName} for component \${component.name}\`);
                
                // Call dt-client-cli to set the property
                const { execSync } = require('child_process');
                try {
                  execSync(
                    \`node .oss-management/dist/scripts/dt-client-cli.js set-property \"$PROJECT_NAME\" \"$VERSION\" '\${componentJson}' \"\${propertyName}\" \"\${propertyValue}\"\`,
                    { stdio: 'inherit' }
                  );
                } catch (error) {
                  console.error(\`Failed to set property for component \${component.name}: \${error.message}\`);
                  // Continue with other components
                }
              }
            }
            
            console.log('All component properties set successfully');
          "
        env:
          DT_BASE_URL: ${{ secrets.DT_BASE_URL }}
          DT_API_KEY: ${{ secrets.DT_API_KEY }}
      
      - name: Add comment to approval issue (approved)
        if: steps.check-approval.outputs.approved == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: '‚úÖ ÊâøË™ç„ÅåÂÆå‰∫Ü„Åó„Åæ„Åó„Åü„ÄÇ\n\nüì¶ SBOM„ÅåDependency-Track„Å´ÁôªÈå≤„Åï„Çå„Åæ„Åó„Åü„ÄÇ\nüîß „Ç≥„É≥„Éù„Éº„Éç„É≥„Éà„Éó„É≠„Éë„ÉÜ„Ç£„ÅåË®≠ÂÆö„Åï„Çå„Åæ„Åó„Åü„ÄÇ'
            });
      
      - name: Add comment to approval issue (not approved)
        if: steps.check-approval.outputs.approved == 'false'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: '‚ùå ÊâøË™ç„Åï„Çå„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇDependency-Track„Å∏„ÅÆÁôªÈå≤„ÅØË°å„Çè„Çå„Åæ„Åõ„Çì„ÄÇ'
            });
